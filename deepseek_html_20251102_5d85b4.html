<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚¹å‡»ç»Ÿè®¡é¢æ¿</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š WhatsAppç¾¤é“¾æ¥ç‚¹å‡»ç»Ÿè®¡</h1>
            <p>åŸºäºæµè§ˆå™¨æœ¬åœ°å­˜å‚¨çš„ç‚¹å‡»æ•°æ®åˆ†æ</p>
        </div>

        <div class="stats" id="stats">
            <!-- ç»Ÿè®¡ä¿¡æ¯åŠ¨æ€åŠ è½½ -->
        </div>

        <div class="controls">
            <button onclick="exportData()" class="btn">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
            <button onclick="clearData()" class="btn btn-danger">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
            <button onclick="loadData()" class="btn">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <label class="auto-refresh">
                <input type="checkbox" id="autoRefresh" checked> è‡ªåŠ¨åˆ·æ–° (æ¯30ç§’)
            </label>
        </div>

        <div class="last-update" id="lastUpdate">æœ€åæ›´æ–°: --</div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ç‚¹å‡»æ—¶é—´</th>
                        <th>è®¾å¤‡å¹³å°</th>
                        <th>æµè§ˆå™¨è¯­è¨€</th>
                        <th>æ¥æº</th>
                        <th>ç”¨æˆ·ä»£ç†</th>
                    </tr>
                </thead>
                <tbody id="clickData">
                    <tr><td colspan="6" style="text-align: center;">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="chart-container">
            <h3>ğŸ“ˆ ç‚¹å‡»æ—¶é—´åˆ†å¸ƒ</h3>
            <div id="timeChart" class="chart">
                <!-- æ—¶é—´åˆ†å¸ƒå›¾è¡¨ -->
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let refreshInterval;

        function loadData() {
            const clicks = getClickData();
            updateStats(clicks);
            updateTable(clicks);
            updateTimeChart(clicks);
            document.getElementById('lastUpdate').textContent = 
                `æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')}`;
        }

        function updateStats(clicks) {
            const totalClicks = clicks.length;
            const todayClicks = clicks.filter(click => {
                const clickDate = new Date(click.timestamp).toDateString();
                return clickDate === new Date().toDateString();
            }).length;
            
            const platforms = [...new Set(clicks.map(click => click.platform))].length;
            const languages = [...new Set(clicks.map(click => click.language))].length;

            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalClicks}</div>
                    <div class="stat-label">æ€»ç‚¹å‡»é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${todayClicks}</div>
                    <div class="stat-label">ä»Šæ—¥ç‚¹å‡»</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${platforms}</div>
                    <div class="stat-label">è®¾å¤‡ç±»å‹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${languages}</div>
                    <div class="stat-label">è¯­è¨€ç±»å‹</div>
                </div>
            `;
        }

        function updateTable(clicks) {
            const tbody = document.getElementById('clickData');
            
            if (clicks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            clicks.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            tbody.innerHTML = clicks.map((click, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${click.timestamp}</td>
                    <td><span class="badge">${getPlatformIcon(click.platform)} ${click.platform}</span></td>
                    <td>${click.language}</td>
                    <td>${click.referrer === 'ç›´æ¥è®¿é—®' ? 'ğŸ”— ç›´æ¥è®¿é—®' : 'ğŸŒ å¤–éƒ¨é“¾æ¥'}</td>
                    <td title="${click.userAgent}">
                        ${getBrowserInfo(click.userAgent)}
                    </td>
                </tr>
            `).join('');
        }

        function updateTimeChart(clicks) {
            const last24Hours = Array(24).fill(0);
            const now = new Date();
            
            clicks.forEach(click => {
                const clickTime = new Date(click.timestamp);
                const hoursAgo = Math.floor((now - clickTime) / (1000 * 60 * 60));
                
                if (hoursAgo < 24) {
                    last24Hours[23 - hoursAgo]++;
                }
            });
            
            const chart = document.getElementById('timeChart');
            chart.innerHTML = `
                <div class="chart-bars">
                    ${last24Hours.map((count, hour) => `
                        <div class="chart-bar-container">
                            <div class="chart-bar" style="height: ${Math.max(count * 10, 5)}px;" 
                                 title="${23 - hour}å°æ—¶å‰: ${count}æ¬¡ç‚¹å‡»">
                            </div>
                            <div class="chart-label">${23 - hour}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getPlatformIcon(platform) {
            if (platform.includes('Win')) return 'ğŸ’»';
            if (platform.includes('Mac')) return 'ğŸ';
            if (platform.includes('Linux')) return 'ğŸ§';
            if (platform.includes('iPhone') || platform.includes('Android')) return 'ğŸ“±';
            return 'ğŸ–¥ï¸';
        }

        function getBrowserInfo(userAgent) {
            if (userAgent.includes('Chrome')) return 'Chrome';
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Safari')) return 'Safari';
            if (userAgent.includes('Edge')) return 'Edge';
            return 'å…¶ä»–æµè§ˆå™¨';
        }

        function exportData() {
            const clicks = getClickData();
            const dataStr = JSON.stringify(clicks, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `whatsapp-clicks-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function clearData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem('whatsappClicks');
                localStorage.removeItem('clickCount');
                loadData();
                alert('æ•°æ®å·²æ¸…ç©º');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            document.getElementById('autoRefresh').addEventListener('change', function(e) {
                if (e.target.checked) {
                    refreshInterval = setInterval(loadData, 30000);
                } else {
                    clearInterval(refreshInterval);
                }
            });
            
            refreshInterval = setInterval(loadData, 30000);
        });
    </script>
</body>
</html>